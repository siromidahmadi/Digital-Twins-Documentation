<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Digital Twins Hub — Projects</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0c0c10; --card:#121218; --muted:#a5a7b0; --text:#e9e9ef; --primary:#c9a24a; --primary2:#9b7b2e; --border:rgba(255,255,255,0.08); --ring:rgba(201,162,74,0.35); --shadow:0 20px 50px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.03); }
    body { margin:0; background: radial-gradient(1200px 600px at 10% -10%, rgba(201,162,74,.15), transparent 60%), radial-gradient(1000px 500px at 100% 0%, rgba(90,90,255,.08), transparent 50%), var(--bg); color:var(--text); font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; -webkit-font-smoothing:antialiased; }
    header { position:sticky; top:0; z-index:5; background:linear-gradient(180deg, rgba(12,12,16,.9), rgba(12,12,16,.6)); backdrop-filter: blur(6px); border-bottom:1px solid var(--border); }
    .shell { max-width:1100px; margin:0 auto; padding:18px 22px; display:flex; align-items:center; justify-content:space-between; }
    .brand { display:flex; align-items:center; gap:12px; color:var(--text); text-decoration:none; }
    .brand-mark { width:36px; height:36px; border-radius:12px; background:linear-gradient(135deg, var(--primary), var(--primary2)); display:grid; place-items:center; color:#0b0b0b; font-weight:700; box-shadow:var(--shadow); }
    .brand-title { font-family:'Playfair Display',serif; font-size:1.2rem; letter-spacing:.4px; }
    nav a { color:var(--muted); text-decoration:none; margin-left:14px; font-weight:500; }
    nav a:hover { color:var(--text); }

    main { padding:32px 22px 60px; }
    .container { max-width:1100px; margin:0 auto; }
    .hero { display:flex; align-items:flex-end; justify-content:space-between; gap:20px; margin-bottom:18px; }
    .hero h1 { margin:0; font-family:'Playfair Display',serif; font-size:2rem; }
    .hint { color:var(--muted); }

    .controls { margin: 14px 0 20px; }
    .tabs { display:flex; gap:10px; flex-wrap:wrap; }
    .tab { padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.02); color:var(--muted); cursor:pointer; font-weight:600; }
    .tab:hover { color:var(--text); border-color:var(--primary); box-shadow:0 0 0 3px var(--ring); }
    .tab.active { color:#0b0b0b; background:linear-gradient(135deg, var(--primary), var(--primary2)); border-color:transparent; box-shadow:0 8px 24px rgba(201,162,74,.25); }

    .list { display:grid; gap:14px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)); border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); padding:16px 18px; opacity:0; transform: translateY(20px); animation: fadeInUp .5s forwards; }
    .item-title { margin:0 0 6px; font-size:1.1rem; font-weight:600; color:#fff; }
    .meta { color:var(--muted); margin:4px 0 10px; }
    .btn { background:linear-gradient(135deg, var(--primary), var(--primary2)); border:none; color:#0b0b0b; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; box-shadow:0 8px 24px rgba(201,162,74,.25); }
    .btn:hover { box-shadow:0 12px 28px rgba(201,162,74,.35); }
    .btn-row { display:flex; gap:8px; flex-wrap:wrap; }
    .btn-ghost { background: rgba(255,255,255,.05); color: var(--text); border:1px solid var(--border); }
    .btn-danger { background: linear-gradient(135deg, #ff6b6b, #d64545); color: #fff; }
    @keyframes fadeInUp { to { opacity:1; transform: translateY(0); } }

    footer { border-top:1px solid var(--border); }
    .foot-inner { max-width:1100px; margin:0 auto; padding:18px 22px; color:var(--muted); }
  </style>
</head>
<body>
  <header>
    <div class="shell">
      <a class="brand" href="index.html">
        <div class="brand-mark">DH</div>
        <div class="brand-title">Digital Twins Hub</div>
      </a>
      <nav>
        <a href="index.html">Home</a>
        <a href="add-project.html">Add Project</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="hero">
        <div>
          <h1>Projects</h1>
          <div class="hint">Browse saved projects and export any to PDF.</div>
        </div>
      </div>

      <div class="controls">
        <div class="tabs" id="categoryTabs">
          <button class="tab active" data-filter="">All</button>
          <button class="tab" data-filter="computer-science">Computer Science</button>
          <button class="tab" data-filter="architecture">Architecture / Other Team</button>
        </div>
      </div>

      <section id="saved-projects" class="list">
        <p class="hint">No projects yet.</p>
      </section>
    </div>
  </main>

  <footer>
    <div class="foot-inner">© <span id="year"></span> Digital Twins Hub</div>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    const STORAGE_KEY = 'digitalTwinsProjects';
    let currentFilter = '';

    function downloadProjectPDF(index){
      const projects = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      const p = projects[index];
      if(!p) return;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'mm', format: 'a4' });
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 15;
      const maxWidth = pageWidth - margin * 2;
      const line = 6; // line height
      let y = margin + 12; // leave room for header

      function decoratePages(){
        const pageCount = doc.getNumberOfPages();
        for(let i=1;i<=pageCount;i++){
          doc.setPage(i);
          // Header brand
          doc.setDrawColor(201,162,74);
          doc.setLineWidth(0.6);
          doc.line(margin, 14, pageWidth - margin, 14);
          doc.setFont('helvetica','bold');
          doc.setFontSize(11);
          doc.setTextColor(0);
          doc.text('Digital Twins Hub', margin, 11);

          // Footer page numbers
          doc.setFont('helvetica','normal');
          doc.setFontSize(9);
          doc.setTextColor(120);
          doc.text(`Page ${i} of ${pageCount}`, pageWidth/2, pageHeight - 8, { align: 'center' });
        }
      }

      function ensureSpace(needed){
        if(y + needed > pageHeight - margin){
          doc.addPage();
          y = margin;
        }
      }

      function writeHeading(text){
        ensureSpace(line*2);
        doc.setFont('helvetica','bold');
        doc.setFontSize(18);
        doc.setTextColor(0);
        doc.text(text, margin, y);
        y += line * 1.5;
      }

      function writeSubheading(text){
        ensureSpace(line*1.5);
        doc.setFont('helvetica','bold');
        doc.setFontSize(13);
        doc.setTextColor(40,40,40);
        doc.text(text, margin, y);
        y += line;
      }

      // Normalize most whitespace to avoid per-letter spacing issues
      function normalizeText(t){
        return String(t || '')
          .replace(/\r/g, '')
          .replace(/[\u00A0\u200B\u200C\u200D]/g, ' ') // nbsp and zero-width chars
          .replace(/[ \t]+/g, ' ');
      }

      function writeParagraph(text){
        if(!text) return;
        doc.setFont('helvetica','normal');
        doc.setFontSize(11);
        doc.setTextColor(0);
        const lines = doc.splitTextToSize(normalizeText(text), maxWidth);
        lines.forEach((ln) => {
          ensureSpace(line);
          doc.text(ln, margin, y);
          y += line;
        });
      }

      function writeField(label, value){
        if(!value || (Array.isArray(value) && !value.length)) return;
        ensureSpace(line*1.5);
        doc.setFont('helvetica','bold');
        doc.setFontSize(12);
        doc.setTextColor(0);
        doc.text(label, margin, y);
        y += line;
        writeParagraph(Array.isArray(value) ? value.join(', ') : value);
        y += 2;
      }

      // Reset spacing controls to avoid letter gaps
      if (typeof doc.setCharSpace === 'function') doc.setCharSpace(0);
      if (typeof doc.setLineHeightFactor === 'function') doc.setLineHeightFactor(1.15);

      // Title header
      writeHeading(p.title || 'Project');
      doc.setFont('helvetica','normal');
      doc.setFontSize(10);
      doc.setTextColor(90);
      doc.text(`${p.category || 'Uncategorized'} • ${p.owner || 'Unknown owner'} • ${p.date ? new Date(p.date).toLocaleString() : ''}`, margin, y);
      y += line;
      doc.setDrawColor(220);
      doc.line(margin, y, pageWidth - margin, y);
      y += 4;

      // Sections
      writeSubheading('Goal');
      writeParagraph(p.goal);

      writeField('Key Features', p.features);
      writeField('File Structure', p.fileStructure);

      if(Array.isArray(p.modules) && p.modules.length){
        writeSubheading('Modules');
        p.modules.forEach((m) => {
          const lineText = `• ${m.title}${m.function ? ' — ' + m.function : ''}${(m.dataTypes && m.dataTypes.length) ? ' [' + m.dataTypes.join(', ') + ']' : ''}${m.problemSolved ? ' — ' + m.problemSolved : ''}`;
          writeParagraph(lineText);
        });
        y += 2;
      }

      writeField('Module Functions', p.moduleFunctions);
      writeField('Problem it Solves', p.problem);
      writeField('Data Types', p.dataTypes);
      writeField('Conclusion', p.conclusion);

      decoratePages();
      doc.save(`${(p.title || 'project').replace(/\s+/g,'_')}.pdf`);
    }

    function renderItem(p, index, sourceArray){
      const card = document.createElement('div');
      card.className = 'card project-card';
      card.innerHTML = `
        <h3 class="item-title">${p.title}</h3>
        <div class="meta">${p.category || 'Uncategorized'} • ${p.owner || 'Unknown owner'}</div>
        <p style="margin:8px 0 12px">${p.goal || ''}</p>
        <div class="btn-row">
          <button class="btn" onclick="downloadProjectPDF(${index})">📥 Download PDF</button>
          <button class="btn btn-ghost" onclick="modifyProject(${index})">✏️ Modify</button>
          <button class="btn btn-danger" onclick="deleteProject(${index})">🗑 Delete</button>
        </div>
      `;
      return card;
    }

    function loadProjects(){
      const projects = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      const container = document.getElementById('saved-projects');
      container.innerHTML = '';
      const filtered = currentFilter ? projects.filter(p => p.category === currentFilter) : projects;
      if(!filtered.length){ container.innerHTML = '<p class="hint">No projects yet for this category.</p>'; return; }
      filtered.slice().reverse().forEach((p, i) => container.appendChild(renderItem(p, projects.indexOf(p), projects)));
      const cards = container.querySelectorAll('.project-card');
      cards.forEach((card, i) => { card.style.animationDelay = `${i * 0.08}s`; });
    }

    function deleteProject(idx){
      const projects = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      if(idx < 0 || idx >= projects.length) return;
      if(!confirm('Delete this project?')) return;
      projects.splice(idx, 1);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(projects));
      loadProjects();
    }

    function modifyProject(idx){
      const projects = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      const p = projects[idx];
      if(!p) return;
      const title = prompt('Title:', p.title || '');
      if(title === null) return;
      const category = prompt('Category (computer-science | architecture):', p.category || '');
      if(category === null) return;
      const owner = prompt('Owner:', p.owner || '');
      if(owner === null) return;
      const goal = prompt('Goal:', p.goal || '');
      if(goal === null) return;
      p.title = title.trim();
      p.category = (category || '').trim();
      p.owner = owner.trim();
      p.goal = goal.trim();
      projects[idx] = p;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(projects));
      loadProjects();
    }

    function setupTabs(){
      const tabs = document.querySelectorAll('#categoryTabs .tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentFilter = tab.getAttribute('data-filter') || '';
          loadProjects();
        });
      });
    }

    document.addEventListener('DOMContentLoaded', () => { setupTabs(); loadProjects(); });
  </script>
</body>
</html>
